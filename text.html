<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MovieCove</title>

<meta name="theme-color" content="#e50914">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
header{background:#111;padding:12px 20px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:10}
#logo{height:50px}
#siteName{font-size:24px;font-weight:bold;color:#e50914}
#userEmail{margin-left:auto;font-size:13px;opacity:.8}

#searchBox{width:calc(100% - 40px);margin:12px 20px;padding:12px;border-radius:6px;border:none;font-size:16px}

#movies{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;padding:12px 20px}

.movie{background:#111;border-radius:10px;overflow:hidden;cursor:pointer;position:relative}
.movie img{width:100%}
.movie h4{font-size:14px;margin:6px 8px}
.rating{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);padding:2px 6px;font-size:12px;border-radius:4px}

/* PLAYER */
#playerBox{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.95);
  display:none;
  z-index:9999;
  overflow-y:auto
}
#player{
  max-width:900px;
  margin:20px auto;
  background:#111;
  border-radius:10px;
  overflow:hidden
}
#playerHeader{
  background:#000;
  padding:10px;
  display:flex;
  align-items:center;
  gap:10px
}
#playerHeader img{height:30px}
#playerTitle{flex:1;font-size:15px}
#playerHeader button{background:none;border:none;color:#fff;font-size:20px}

video{width:100%;max-height:60vh;background:#000}

#info{padding:12px;font-size:14px;color:#ccc}
#episodes button{
  margin:4px;
  padding:6px 10px;
  background:#222;
  border:none;
  color:#fff;
  border-radius:4px;
  font-size:12px
}
#downloadBtn{
  width:100%;
  margin-top:10px;
  padding:10px;
  background:#e50914;
  border:none;
  color:#fff;
  border-radius:6px;
  font-size:15px
}
</style>
</head>

<body>

<header>
  <img src="logo.png" id="logo">
  <div id="siteName">MovieCove</div>
  <div id="userEmail">Not logged in</div>
</header>

<input id="searchBox" placeholder="Search movies...">
<div id="movies"></div>

<!-- PLAYER -->
<div id="playerBox">
  <div id="player">
    <div id="playerHeader">
      <img src="logo.png">
      <div id="playerTitle">Now Playing</div>
      <button onclick="closePlayer()">✖</button>
    </div>

    <video id="video" controls playsinline></video>

    <div id="info">
      <p id="desc"></p>
      <div id="episodes"></div>
      <button id="downloadBtn" style="display:none">Download</button>
    </div>
  </div>
</div>

<script>
const BACKEND = "https://moviecove-backend.onrender.com";
const API_TOKEN = "moviecove_secure_token_08166704020_tony";

const movies = document.getElementById("movies");
const video = document.getElementById("video");
const playerBox = document.getElementById("playerBox");
const titleBox = document.getElementById("playerTitle");
const desc = document.getElementById("desc");
const episodes = document.getElementById("episodes");
const downloadBtn = document.getElementById("downloadBtn");
const userEmail = document.getElementById("userEmail");

function isLoggedIn(){ return localStorage.getItem("loggedIn")==="yes"; }
function email(){ return localStorage.getItem("userEmail"); }

userEmail.textContent = isLoggedIn()?email():"Not logged in";

async function api(path){
  const r = await fetch(BACKEND + path,{
    headers:{ "Authorization":"Bearer "+API_TOKEN }
  });
  return r.json();
}

async function loadMovies(q="latest"){
  movies.innerHTML="Loading...";
  try{
    const j = await api(`/movies?q=${encodeURIComponent(q)}`);
    movies.innerHTML="";
    j.items.forEach(m=>{
      if(!m.subjectId) return;
      const d=document.createElement("div");
      d.className="movie";
      d.innerHTML=`
        <img src="${m.cover?.url||''}">
        <div class="rating">${m.imdbRatingValue||"N/A"}★</div>
        <h4>${m.title}</h4>
      `;
      d.onclick=()=>openMovie(m);
      movies.appendChild(d);
    });
  }catch{
    movies.innerHTML="Failed to load movies";
  }
}

async function openMovie(m){
  if(!isLoggedIn()){
    location.href="login.html";
    return;
  }

  titleBox.textContent=m.title;
  desc.textContent=m.description||"";
  episodes.innerHTML="";
  downloadBtn.style.display="none";

  playerBox.style.display="block";

  await playStream(m.subjectId);
}

async function playStream(info, season=null, episode=null){
  video.pause();
  video.removeAttribute("src");
  video.load();

  let url=`/stream?info=${info}`;
  if(season && episode) url+=`&season=${season}&episode=${episode}`;

  const j = await api(url);
  if(!j.playable){
    desc.textContent="Stream unavailable";
    return;
  }

  video.src=j.stream;
  video.load();
  video.play().catch(()=>{});

  // Subtitles
  video.innerHTML="";
  (j.subtitles||[]).forEach(s=>{
    const t=document.createElement("track");
    t.kind="subtitles";
    t.label=s.label||"Sub";
    t.src=s.url;
    t.srclang=s.lang||"en";
    video.appendChild(t);
  });

  if(j.download){
    downloadBtn.style.display="block";
    downloadBtn.onclick=()=>window.open(j.download,"_blank");
  }
}

function closePlayer(){
  video.pause();
  video.removeAttribute("src");
  video.load();
  playerBox.style.display="none";
}

searchBox.oninput=()=>loadMovies(searchBox.value||"latest");
loadMovies("latest");
</script>

</body>
  </html>
