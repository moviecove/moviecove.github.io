<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MovieCove</title>

<meta name="theme-color" content="#e50914">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif}
header{position:sticky;top:0;z-index:1000;display:flex;align-items:center;gap:15px;padding:12px 20px;background:#111}
#logo{height:70px}
#siteName{font-size:26px;font-weight:bold;background:linear-gradient(90deg,#e50914,#ff4500);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#userEmail{margin-left:auto;font-size:14px;opacity:.8}
#searchBox{width:calc(100% - 40px);margin:12px 20px;padding:12px;font-size:16px;border-radius:6px;border:none}
#movies{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;padding:12px 20px}
.movie{background:#111;border-radius:10px;overflow:hidden;cursor:pointer;position:relative;transition:.2s}
.movie:hover{transform:scale(1.05)}
.movie img{width:100%;display:block}
.movie h4{font-size:14px;margin:6px 8px}
.rating{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.7);color:#ffd700;padding:2px 6px;font-size:12px;border-radius:4px}
.download-btn{position:absolute;bottom:8px;left:8px;background:#e50914;color:#fff;border:none;padding:4px 8px;font-size:11px;border-radius:4px;display:none}
.download-btn.visible{display:block}
#playerBox{position:fixed;inset:0;background:#000;display:none;z-index:9999}
#playerHeader{display:flex;align-items:center;background:#111;padding:8px}
#playerHeader span{color:#e50914;font-weight:bold}
#playerHeader div{margin-left:auto}
#playerHeader button{background:none;border:none;color:#fff;font-size:20px}
#playerBox iframe{width:100%;height:calc(100% - 40px);border:none}
.minimized{width:75vw;height:42vw;inset:auto 10px 80px auto}
nav{position:fixed;bottom:0;left:0;right:0;background:#111;display:flex;justify-content:space-around;padding:10px 0}
nav a{color:#fff}
footer{text-align:center;padding:12px;background:#111;color:#777}
</style>
</head>

<body>

<header>
  <img src="logo.png" id="logo">
  <div id="siteName">MovieCove</div>
  <div id="userEmail">Not logged in</div>
</header>

<input id="searchBox" placeholder="Search movies or series...">
<div id="movies"></div>

<div id="playerBox">
  <div id="playerHeader">
    <span>MC</span>
    <div>
      <button id="minBtn"><i class="fa-solid fa-minus"></i></button>
      <button id="closeBtn"><i class="fa-solid fa-xmark"></i></button>
    </div>
  </div>
  <iframe id="playerFrame" allowfullscreen></iframe>
</div>

<nav>
  <a href="#"><i class="fa-solid fa-house"></i></a>
  <a href="#"><i class="fa-solid fa-video"></i></a>
  <a href="#"><i class="fa-solid fa-gear"></i></a>
  <a href="#" id="logout"><i class="fa-solid fa-arrow-right-from-bracket"></i></a>
</nav>

<footer>© MovieCove</footer>

<script>
const API_BASE = "https://apis.davidcyril.name.ng/cineverse";

const moviesDiv = document.getElementById("movies");
const searchBox = document.getElementById("searchBox");
const playerBox = document.getElementById("playerBox");
const frame = document.getElementById("playerFrame");
const closeBtn = document.getElementById("closeBtn");
const minBtn = document.getElementById("minBtn");
const logout = document.getElementById("logout");
const userEmailDiv = document.getElementById("userEmail");

function isLoggedIn(){ return localStorage.getItem("loggedIn")==="yes"; }
function getUserEmail(){ return localStorage.getItem("userEmail"); }
userEmailDiv.textContent = isLoggedIn()?getUserEmail():"Not logged in";

async function loadContent(q="trending"){
  moviesDiv.innerHTML="Loading...";
  const res = await fetch(`${API_BASE}?q=${encodeURIComponent(q)}`);
  const json = await res.json();
  const items = json?.data?.data?.items || [];
  moviesDiv.innerHTML="";
  items.forEach(item=>{
    if(!item.subjectId || !item.cover?.url) return;
    const card=document.createElement("div");
    card.className="movie";
    card.innerHTML=`
      <img src="${item.cover.url}">
      <div class="rating">${item.imdbRatingValue || "N/A"} ★</div>
      <h4>${item.title}</h4>
      <button class="download-btn">Download</button>
    `;
    card.onclick=()=>playContent(item.subjectId);
    moviesDiv.appendChild(card);
    checkDownloadable(item.subjectId,card.querySelector(".download-btn"));
  });
}

async function checkDownloadable(id,btn){
  try{
    const res=await fetch(`${API_BASE}/sources?info=${id}`);
    const json=await res.json();
    const downloads=json?.data?.data?.downloads||[];
    if(!downloads.length) return;

    const best = downloads
      .filter(d=>d.url)
      .sort((a,b)=>(b.resolution||0)-(a.resolution||0))[0];

    if(!best) return;

    btn.classList.add("visible");
    btn.onclick=e=>{
      e.stopPropagation();
      window.open(best.url,"_blank");
    };
  }catch{}
}

async function playContent(id){
  if(!isLoggedIn()){
    alert("Login required");
    return;
  }

  playerBox.style.display="block";
  frame.src="";

  try{
    const res=await fetch(`${API_BASE}/sources?info=${id}`);
    const json=await res.json();
    const data=json?.data?.data;

    const stream =
      data?.watch ||
      data?.stream ||
      data?.embed;

    if(!stream){
      alert("No stream available");
      closeBtn.click();
      return;
    }

    frame.src = stream;

  }catch{
    alert("Failed to load stream");
    closeBtn.click();
  }
}

closeBtn.onclick=()=>{
  frame.src="";
  playerBox.style.display="none";
};
minBtn.onclick=()=>playerBox.classList.toggle("minimized");

searchBox.oninput=()=>loadContent(searchBox.value||"trending");
logout.onclick=()=>{localStorage.clear();location.reload();};

loadContent();
</script>

</body>
</html>
