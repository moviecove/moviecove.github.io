<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MovieCove</title>

<meta name="theme-color" content="#000">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
*{box-sizing:border-box}
body{margin:0;background:#000;color:#fff;font-family:system-ui,Arial}

/* HEADER */
header{
  position:sticky;top:0;z-index:1000;
  background:#111;padding:12px 16px;
  display:flex;align-items:center
}
header img{height:100px}
#username{margin-left:auto;font-size:13px;opacity:.9}

/* THEME */
:root{
  --bg:#000;--card:#111;--text:#fff;--muted:#aaa;--accent:#e50914
}
body.light{
  --bg:#f5f5f5;--card:#fff;--text:#000;--muted:#555
}
body{background:var(--bg);color:var(--text)}
header,nav,.poster,#player{background:var(--card)}

/* SEARCH */
#search{
  width:calc(100% - 32px);
  margin:12px 16px;padding:12px;
  border-radius:8px;border:none;font-size:15px
}

/* GRID */
#movies,.recommendGrid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(110px,1fr));
  gap:12px;padding:12px 16px
}

/* CARD */
.movie{cursor:pointer}
.poster{
  position:relative;width:100%;
  aspect-ratio:2/3;border-radius:10px;
  overflow:hidden;background:#222
}
.poster img{width:100%;height:100%;object-fit:cover}
.rating{
  position:absolute;top:6px;right:6px;
  background:rgba(0,0,0,.7);
  font-size:11px;padding:3px 6px;border-radius:4px
}
.movie h4{
  font-size:13px;margin:6px 2px 0;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}

/* PLAYER */
#player{
  position:fixed;inset:0;background:#000;
  display:none;z-index:9999;overflow:auto
}
#playerCard{max-width:1000px;margin:auto}
#playerHeader{
  display:flex;align-items:center;padding:10px
}
#playerHeader img{height:50px}
#playerTitle{flex:1;margin-left:10px;font-size:14px}
#close{font-size:20px;cursor:pointer}

/* VIDEO */
.videoWrap{width:100%;height:55vh;background:#000}
video{width:100%;height:100%}

/* DETAILS */
#details{padding:14px}
.sectionTitle{margin:16px 0 8px;font-weight:bold}
#download{
  width:100%;margin-top:14px;padding:14px;
  background:#e50914;border:none;color:#fff;
  font-size:15px;border-radius:8px
}

/* NAV */
nav{
  position:fixed;bottom:0;left:0;right:0;
  background:#111;display:flex;
  justify-content:space-around;padding:10px 0
}
nav a{
  color:#fff;font-size:13px;text-decoration:none;
  display:flex;flex-direction:column;
  align-items:center;gap:4px
}
</style>
</head>

<body>

<header>
  <img src="logo.png">
  <div id="username"></div>
</header>

<input id="search" placeholder="Search movies…">
<div id="movies"></div>

<!-- PLAYER -->
<div id="player">
  <div id="playerCard">
    <div id="playerHeader">
      <img src="logo.png">
      <div id="playerTitle"></div>
      <div id="close">✖</div>
    </div>

    <div class="videoWrap">
      <video id="video" controls playsinline></video>
    </div>

    <div id="details">
      <div id="description"></div>
      <div id="cast"></div>

      <div class="sectionTitle">Recommended</div>
      <div class="recommendGrid"></div>

      <button id="download">Download</button>
    </div>
  </div>
</div>

<nav>
  <a href="home.html"><i class="fa-solid fa-house"></i><span>Home</span></a>
  <a href="continue1.html"><i class="fa-solid fa-clock-rotate-left"></i><span>Continue</span></a>
  <a href="settings1.html"><i class="fa-solid fa-gear"></i><span>Settings</span></a>
</nav>

<script>
/* AUTH */
if(localStorage.getItem("loggedIn")!=="yes") location.href="login.html";
const email=localStorage.getItem("userEmail");
if(email) username.textContent=email.split("@")[0];

const BACKEND="https://moviecove-backend.onrender.com";
const TOKEN="moviecove_secure_token_08166704020_tony";

const moviesBox=document.getElementById("movies");
const player=document.getElementById("player");
const video=document.getElementById("video");
const titleBox=document.getElementById("playerTitle");
const descBox=document.getElementById("description");
const castBox=document.getElementById("cast");
const recGrid=document.querySelector(".recommendGrid");
const downloadBtn=document.getElementById("download");

let currentMovie=null;
let saveInterval=null;
let streamLoaded=false;

/* CONTINUE */
function getCW(){return JSON.parse(localStorage.getItem("continueWatching")||"{}")}
function saveCW(id,data){
  const all=getCW();all[id]=data;
  localStorage.setItem("continueWatching",JSON.stringify(all))
}
function removeCW(id){
  const all=getCW();delete all[id];
  localStorage.setItem("continueWatching",JSON.stringify(all))
}

/* LOAD MOVIES */
async function loadMovies(q="latest"){
  moviesBox.innerHTML="Loading...";
  const r=await fetch(`${BACKEND}/movies?q=${encodeURIComponent(q)}`,{
    headers:{Authorization:`Bearer ${TOKEN}`}
  });
  const j=await r.json();
  moviesBox.innerHTML="";

  if(!j.items || !j.items.length){
    moviesBox.innerHTML="<p style='padding:16px'>No movies found</p>";
    return;
  }

  j.items.forEach(m=>{
    const el=document.createElement("div");
    el.className="movie";
    el.innerHTML=`
      <div class="poster">
        <img src="${m.cover?.url||''}">
        <div class="rating">${m.imdbRatingValue||"N/A"}★</div>
      </div>
      <h4>${m.title}</h4>
    `;
    el.onclick=()=>openMovie(m,j.items);
    moviesBox.appendChild(el);
  });
}

/* OPEN PLAYER */
async function openMovie(m,all){
  currentMovie=m;
  streamLoaded=false;
  player.style.display="block";
  titleBox.textContent=m.title;
  descBox.innerHTML=m.description||"";
  castBox.innerHTML=m.cast?m.cast.join(", "):"";
  recGrid.innerHTML="";
  video.pause();

  all.filter(x=>x.subjectId!==m.subjectId).slice(0,10).forEach(rm=>{
    const el=document.createElement("div");
    el.className="movie";
    el.innerHTML=`<div class="poster"><img src="${rm.cover?.url||''}"></div><h4>${rm.title}</h4>`;
    el.onclick=()=>openMovie(rm,all);
    recGrid.appendChild(el);
  });

  const r=await fetch(`${BACKEND}/stream?info=${m.subjectId}`,{
    headers:{Authorization:`Bearer ${TOKEN}`}
  });
  const j=await r.json();
  if(!j.playable) return;

  if(!streamLoaded){
    video.src=j.stream;
    streamLoaded=true;
  }

  downloadBtn.onclick=()=>window.open(j.download,"_blank");

  const saved=getCW()[m.subjectId];
  video.onloadedmetadata=()=>{
    if(saved && saved.time<video.duration-5){
      video.currentTime=saved.time;
    }
    video.onloadedmetadata=null;
  };

  startSave();
}

/* SAVE */
function startSave(){
  clearInterval(saveInterval);
  saveInterval=setInterval(()=>{
    if(!currentMovie||video.paused||video.ended) return;
    saveCW(currentMovie.subjectId,{
      title:currentMovie.title,
      poster:currentMovie.cover?.url,
      time:Math.floor(video.currentTime),
      duration:Math.floor(video.duration)
    });
  },5000);
}

video.addEventListener("ended",()=>currentMovie&&removeCW(currentMovie.subjectId));

close.onclick=()=>{
  clearInterval(saveInterval);
  video.pause();
  player.style.display="none";
};

search.oninput=()=>loadMovies(search.value||"latest");
loadMovies();
</script>

</body>
  </html>
